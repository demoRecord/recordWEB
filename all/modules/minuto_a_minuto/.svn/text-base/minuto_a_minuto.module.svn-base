<?php
function minuto_a_minuto_perm(){
	return 	array('narrar partidos','ver partido');
}

function minuto_a_minuto_menu(){
	$items['admin/content/minuto_minuto'] = array(
		'title'				=> 'Minuto a minuto',
		'description'		=> 'Narrar minuto a minuto un partido',
		'access arguments'	=> array('narrar partidos'),
		'page callback'		=> 'minuto_a_minuto_main',
		'type'				=> MENU_NORMAL_ITEM,
		'file'				=> 'minuto_a_minuto.pages.inc'
	);

	$items['admin/content/minuto_minuto/partido/%'] = array(
		'title'				=> 'NarraciÃ³n del Partido',
		'description'		=> '',
		'access arguments'	=> array('narrar partidos'),
		'page callback'		=> 'minuto_a_minuto_narracion',
		'type'				=> MENU_CALLBACK,
		'file'				=> 'minuto_a_minuto.pages.inc',
		'page arguments'	=> array(4)
	);
	$items['admin/content/minuto_minuto/save_status/%'] = array(
		'access arguments'	=> array('narrar partidos'),
		'page callback'		=> 'minuto_a_minuto_save_status',
		'type'				=> MENU_CALLBACK,
		'page arguments'	=> array(4),
		'file'				=> 'minuto_a_minuto.pages.inc'
	);

	$items['admin/content/minuto_minuto/get_item/%'] = array(
		'access arguments'	=> array('narrar partidos'),
		'type'				=> MENU_CALLBACK,
		'file'				=> 'minuto_a_minuto.pages.inc',
		'page arguments'	=> array(4),
		'page callback'		=> 'minuto_a_minuto_get_item' 
	);

	$items['admin/content/minuto_minuto/borrar/%'] = array(
		'access arguments'	=> array('narrar partidos'),
		'type'				=> MENU_CALLBACK,
		'file'				=> 'minuto_a_minuto.pages.inc',
		'page arguments'	=> array(4),
		'page callback'		=> 'minuto_a_minuto_borrar'
	);

	$items['admin/content/minuto_minuto/update/%'] = array(
		'title'				=> 'Update',
		'access arguments'	=> array('narrar partidos'),
		'page callback'		=> 'minuto_a_minuto_update',
		'type'				=> MENU_CALLBACK,
		'file'				=> 'minuto_a_minuto.pages.inc',
	);

	$items['admin/content/minuto_minuto/delete/%'] = array(
		'title'				=> 'Delete',
		'access arguments'	=> array('narrar partidos'),
		'page callback'		=> 'minuto_a_minuto_delete',
		'type'				=> MENU_CALLBACK,
		'page arguments'	=> array(4),
		'file'				=> 'minuto_a_minuto.pages.inc'
	);

	$items['minuto_minuto/%'] = array(
		'title'				=> 'Minuto',
		'access arguments'	=> array('ver partido'),
		'page callback'		=> 'minuto_a_minuto_public',
		'type'				=> MENU_CALLBACK,
		'file'				=> 'minuto_a_minuto.pages.inc',
		'page arguments'	=> array(1)
	);

	$items['minuto_minuto/update'] = array(
		'title'				=> 'update publico',
		'access arguments'	=> array('ver partido'),
		'page callback'		=> 'minuto_a_minuto_public_update',
		'file'				=> 'minuto_a_minuto.pages.inc'
	);

	return $items;
}
function minuto_a_minuto_theme(){
	return array(
				'minuto_main' => array(
					'arguments' => array('list' => NULL),
					'template'	=> 'templates/minuto_a_minuto_main'
				),
				'minuto_narracion'	=> array(
					'arguments'	=> array('list'	=> NULL),
					'template'	=> 'templates/minuto_a_minuto_narracion'
				),
				'minuto_item'		=> array(
					'arguments'	=> array('list' => NULL),
					'template'	=> 'templates/minuto_a_minuto_item'
				),
				'minuto_public'	=> array(
					'arguments' => array('list' => NULL),
					'template'		=> 'templates/minuto_a_minuto_public'
				),
			  	'time_field_time'  => array(
					'arguments' => array('element' => NULL),
				),
				'vacio'			=> array(
					'arguments'	=> array('list'	=> NULL),
					'template'	=> 'templates/vacio'
				)
		);
}


function minuto_a_minuto_form_alter(&$form,$form_state,$form_id){
	if($form_id == "partidos_node_form"){
		$form['#redirect'] = "admin/content/minuto_minuto";
	}
}


function minuto_a_minuto_elements() {
  $type['time_field_time'] = array(
    '#input' => TRUE,
    '#process' => array('time_field_expand_time'),
  );
  return $type;
}

function time_field_expand_time($element) {
  if (empty($element['#value'])) {
    $element['#value'] = array(
      'hour' => intval(format_date(time(), 'custom', 'h')),
      'minute' => intval(format_date(time(), 'custom', 'i')),
    );
  }
  
  $element['#tree'] = TRUE;

  foreach ($element['#value'] as $type => $value) {
    switch ($type) {
      case 'hour':
        $options = drupal_map_assoc(range(0, 23));
        break;
      case 'minute':
        $options = drupal_map_assoc(range(0, 59));
        break;
	}
    
    if ($type == 'hour' || $type == 'minute') {
      foreach ($options as $option) {
        $options[$option] = str_pad($options[$option], 2, '0', STR_PAD_LEFT);
      }
    }
    $parents = $element['#parents'];
    $parents[] = $type;
    $element[$type] = array(
      '#type' => 'select',
      '#default_value' => $element['#value'][$type],
      '#attributes' => $element['#attributes'],
      '#options' => $options,
    );
  }
  return $element;
}

function theme_time_field_time($element) {
  return theme('form_element', $element, '<div class="container-inline">'. $element['#children'] .'</div>');
}


function minuto_a_minuto_init(){
	if(arg(0) == 'minuto_minuto' && is_numeric(arg(1))){
			global $custom_theme;

			$custom_theme = 'blanco';
			init_theme();
	}
}	

/**
 * BLoques
 */
function minuto_a_minuto_block($op = 'list', $delta = '', $edit = array()){
	switch($op){
		case 'list':
			$blocks['minuto_minuto'] = array(
				'info'	=> t('Minuto A Minuto:movil'),
				'cache'	=> BLOCK_NO_CACHE
			);
			return $blocks;	
		case 'view':
			switch($delta) {
				case 'minuto_minuto':
					$block['subject']  = 'Minuto a Minuto Movil';
					$block['content']  = get_minuto_a_minuto_movil();
			}
			return $block;	
	}
}

/** 
 * Minuto a minuto movil
 */
function get_minuto_a_minuto_movil(){
	global $_headers;

	$_headers = "<meta http-equiv=\"refresh\" content=\"60\">";
	$nid = arg(2); 
	


	if(is_null($nid) || !is_numeric($nid)){
		return "done";
	}
	
	$path = drupal_get_path('module','minuto_a_minuto');
	drupal_add_js($path.'/js/minuto_cache.js');
	drupal_add_css($path .'/css/minuto_minuto.css', 'theme', 'all', TRUE);

  $timeline = minuto_a_minuto_timeline($nid,'file');
	
	return  theme('vacio',array('contenido' => $info['content'],'movil' => true));
}


/**
 * Recibe el id de un partido y regresa su timeline
 *
 */
function minuto_a_minuto_timeline($partido_id,$metodo) {
	
	switch($metodo){
	  case 'bd':
		  $info = db_query("SELECT content FROM minuto_cache where game_id = %d",$partido_id);
			$info = db_fetch_array($info);	
		break;
		case 'file':
		  $time = date("H-i");
				
			$filename = "/tmp/$partido_id-$time";
			if( ! file_exists($filename)){

				exec("rm /tmp/$partido_id-*");					
				$node 		= node_load($partido_id);				
				$marcador = $node->field_resultado[0]['value'];
				$local    = $node->field_local[0]['value'];
				$visita   = $node->field_visitante[0]['value'];
				$tiempo = $node->field_status[0]['value'];
				$timeline = get_timeline($partido_id);

				$output = theme(
   			'minuto_public',
					array(
						'timeline' => $timeline,
						'marcador' => $marcador,
						'local'    => $local,
						'visita'   => $visita,
						'tiempo'   => date('Y-m-d-H-i-s',strtotime($time)),
						'status'   => (int)$tiempo
					)
				);	
				$info['content'] = $output;
				$fp = fopen($filename,"a");
				$write = fputs($fp,$output);
				fclose($fp);	
			}else{
				$fp = fopen($filename, "r");
				$info['content'] = fread($fp, filesize($filename));
				fclose($fp);  
			}
		break;
	}

  return $info['content'];
}
?>
