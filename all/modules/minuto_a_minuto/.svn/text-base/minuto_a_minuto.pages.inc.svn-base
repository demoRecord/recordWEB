<?php 
	function minuto_a_minuto_main(){

		$path = drupal_get_path('module','minuto_a_minuto');
		drupal_add_css($path .'/css/minuto_minuto.css', 'theme', 'all', TRUE);
		drupal_add_js($path.'/js/jquery.validate.min.js');
		drupal_add_js($path.'/js/jquery.form.js');
		drupal_add_js($path.'/js/jquery.timer.js');
		drupal_add_js($path.'/js/json2.js');
		drupal_add_js($path.'/js/minuto_a_minuto.js');


		//getting the nodes
		$result = db_query('SELECT * FROM node WHERE type = "partidos" ORDER BY nid DESC ');

		$items = array();
		while($node = db_fetch_object($result)){
			$items[] = array(
				'Partido'	=> $node->title,
				'acciones'	=> 	l('Narrar','admin/content/minuto_minuto/partido/'.$node->nid)." | ".
								l('Borrar','admin/content/minuto_minuto/delete/'.$node->nid,array(	'attributes' => 
																								array('class' => 'borrar_partido')
																								)
								)
			
			);
		}

		$headers = array('Partido','acciones');
		
		$table = theme('table',$headers,$items);


		//Form para agregar nuevo partido
		module_load_include('inc','node','node.pages');
		$form = node_add('partidos'); 

		return theme('minuto_main',array('partidos' => $table,'form' => $form));
	}


	function minuto_a_minuto_narracion($partido_id){

		$path = drupal_get_path('module','minuto_a_minuto');
		drupal_add_css($path .'/css/minuto_minuto.css', 'theme', 'all', TRUE);
		drupal_add_css($path.'/js/jquery.countdown.css','theme','all',TRUE);
		drupal_add_js($path.'/js/jquery.countdown.js');
		drupal_add_js($path.'/js/jquery.form.js');
		drupal_add_js($path.'/js/jquery.timer.js');
		drupal_add_js($path.'/js/json2.js');
		drupal_add_js($path.'/js/jquery.validate.min.js');
		drupal_add_js($path.'/js/minuto_a_minuto.js');

		//Sacando los datos del partido
		$node = node_load($partido_id);

		$list['timeline'] = get_timeline($partido_id,TRUE);

		$list['partido']  = $node->title;

		$list['narracion'] = drupal_get_form('form_narracion');

		return theme('minuto_narracion',$list);
	}


	function form_narracion(){
		
		$result = db_query('SELECT id,action FROM minuto_minuto_icons');
	
		$icons = array(); 
		$icons[0] = '-- Sin Icono--';
		while($item =  db_fetch_array($result)){
			$icons[$item['id']] = $item['action'];
		}

		$form = array('');


		$node_id = arg(4);

		if(empty($node_id) || !is_numeric($node_id)){
			$node_id = 0;
		}
		$node = node_load($node_id);
		$resultado =  $node->field_resultado[0]['value'];
		
		if(empty($resultado)){
			$local = 0;
			$visita = 0;
		}else{
			$resultado = explode("-",$resultado);

			$local = $resultado[0];
			$visita = $resultado[1]; 
		}


		$form['marcador_local'] = array(
			'#type'				=> 'textfield',
			'#title' 			=> t('Marcador Local'),
			'#description'		=> t('Marcador local'),
			'#default_value' 	=>	 '0',
			'#required'			=>  true,
			'#class'			=> 'required',
			'#size' 			=> 5,
			'#value'			=> $local
		);

		$form['marcador_visita'] = array(
			'#type'				=> 'textfield',
			'#title' 			=> t('Marcador Visita'),
			'#description'		=> t('Marcador visita'),
			'#default_value' 	=>	 '0',
			'#class'			=> 'required',
		    '#size' 			=> 5,
			'#required'  		=> true,
			'#value'			=> $visita
		);


		$form['icon'] = array(
			'#type'				=> 'select',
			'#title' 			=> t('Icono'),
			'#description'		=> t('Aparecera esta imagen aun lado de la narración'),
			'#default_value' 	=>	 '0',
			'#options' 			=>	$icons
		);

		$form['narracion'] = array(
			'#type'				=> 'textarea',
			'#title'			=> 'Narracción',
			'#description'		=> 'Escribe aquí la narración de lo que esta ocurriendo',
			'#required'			=>  true,
			'#class'			=> 'required'
		);

		$form['minuto']  = array(
			'#type'				=> 'textfield',
			'#title'			=> 'Minuto',
			'#description'		=> 'Minuto',
			'#size'				=> 5,
			'#class'			=> 'required',
			'#required'			=> true
		);

		//Contador de tiempo
		$form['tiempo'] = array(
			'#type'			=> 'fieldset',
			'#title'		=> 'Tiempo',
			'#collapsible'	=> TRUE,
			'#collapsed'	=> TRUE
		);


		$form['tiempo']['primer_tiempo_start'] = array(
			'#type'			=> 'button',
			'#value'		=> 'Comenzar Primer Tiempo',
			'#submit'		=> FALSE
		);

		$form['tiempo']['segundo_tiempo_start'] = array(
			'#type'			=> 'button',
			'#value'		=> 'Comenzar Segundo Tiempo',
			'#submit'		=> FALSE
		);

		$form['tiempo']['reset_tiempo'] = array(
			'#type'			=> 'button',
			'#value'		=> 'Detener',
			'#submit'		=> FALSE
		);

		$form['node_id']	= array(
			'#type'				=> 'hidden',
			'#value'			=>  $node_id
		);

		$form['submit']	= array(
			'#type'				=> 'submit',
			'#value'			=> 'Enviar'	
		);

		$form['item_id'] = array(
			'#type'				=> 'hidden',
			'#value'			=> ''
		);

		$nid = arg(4);
		$form['#action']	= '/admin/content/minuto_minuto/update/'.$nid;
		$form['#id']		= 'form_narracion';

		return $form;
	}

	function minuto_a_minuto_update(){

		if(!empty($_POST)){
			if(empty($_POST['icon'])){
				$_POST['icon'] = 0;
			}

			if(empty($_POST['narracion'])){
				drupal_set_message('El campo narración es requerido','error');
				header('location:/admin/content/minuto_minuto/partido/'.$_POST['node_id']);
				exit();
			}
     
			if(!empty($_POST['item_id']) && is_numeric($_POST['item_id'])){
				$query = 'UPDATE minuto_minuto SET nid=%d,comment="%s",minute=%d,icon=%d WHERE id = %s';
				db_query($query,$_POST['node_id'],$_POST['narracion'],$_POST['minuto'],$_POST['icon'],$_POST['item_id']);
			}else{
				$query = 'INSERT INTO minuto_minuto (nid,comment,minute,icon) VALUES (%d,"%s","%s",%d)';
				db_query($query,$_POST['node_id'],$_POST['narracion'],$_POST['minuto'],$_POST['icon']);
			}
    
    		$local  = filter_xss(trim($_POST['marcador_local']));
		    $visita = filter_xss(trim($_POST['marcador_visita']));
    		// echo "local = $local <br/>";
	    	// echo "visita = $visita <br/>";
    
	    	$node = node_load($_POST['node_id']);
		    $node->field_resultado[0]['value'] = "{$local}-{$visita}";
	
	    	node_save($node);
    
	
			//Drawing the last item
			if(!empty($_POST['item_id']) && is_numeric($_POST['item_id'])){
				$narracion_id = $_POST['item_id'];
			}else{
				$narracion_id = db_last_insert_id('minuto_minuto','id');
			}


			$result   = db_query("SELECT mm.id,mm.nid,mm.comment,mm.minute,mmi.icon FROM  minuto_minuto as mm LEFT JOIN  minuto_minuto_icons as mmi ON mm.icon =  mmi.id where mm.id = %d",$narracion_id);

			$item = db_fetch_array($result);


			update_cache($node->nid);

			//ID original
			$oid = arg(4);

			$forjson =  array('resultado' => $node->field_resultado[0]['value'],'message' => $item['comment'],'tiempo' => $item['minute'],'id' => $item['id'],'imagen' => $item['icon'],'original_id' => $oid);

			$forjson = drupal_to_js($forjson);
			echo $forjson;
			exit();
		}
	}

	function get_timeline($partido_id,$admin=FALSE){

		$result = db_query("SELECT mm.id,mm.nid,mm.comment,mm.minute,mmi.icon FROM minuto_minuto as mm LEFT JOIN minuto_minuto_icons as mmi ON mm.icon = mmi.id  where nid = %s ORDER BY id DESC",$partido_id);

		$output = "";

		while($item = db_fetch_array($result)){
			$output .= theme('minuto_item',array('item' => $item,'admin' => $admin)); 
		}

		return $output;
	}

	
	/*
		
		Define método por el cual se refleja el minuto a minuto
		
		bd : opción de leer base de datos en cada request
		file : opción para generar archivos cada minuto
	
	*/
	define(metodo,'file');
	
	function minuto_a_minuto_public($partido_id){
	
		// bd, files	
		$metodo = metodo;
		$path = drupal_get_path('module','minuto_a_minuto');
		drupal_add_js($path.'/js/minuto_cache.js');
		drupal_add_css($path .'/css/minuto_minuto.css', 'theme', 'all', TRUE);

    $timeline = minuto_a_minuto_timeline($partido_id,'file');
	
		return  theme('vacio',array('contenido' => $timeline));
	}

	function minuto_a_minuto_get_item($item_id){
		if(empty($item_id) || !is_numeric($item_id)){
			echo "false";
			exit();
		}

		$result = db_query('SELECT * FROM minuto_minuto WHERE id = %d',$item_id);
		$item = db_fetch_array($result);
	
		$json = drupal_to_js($item);
		echo $json;
		exit();
	}

	function minuto_a_minuto_public_update(){
		if(empty($_POST)){
			echo "false";
			exit();
		}
		if(!empty($_POST['last_element']) && is_numeric($_POST['last_element'])){
			$result = db_query('SELECT id FROM minuto_minuto ORDER BY id DESC  LIMIT 1');
			$result = db_fetch_array($result);
			if($result['id'] == $_POST['last_element']){
				echo  "false";
				exit();
			}else{
				$result = db_query("SELECT mm.id,mm.nid,mm.comment,mm.minute,mmi.icon FROM minuto_minuto as mm  LEFT JOIN minuto_minuto_icons as mmi  ON mm.icon = mmi.id ORDER BY id DESC LIMIT 1");
				$item = db_fetch_array($result);
				$nn = $item['nid'];
				$node = node_load($nn);


				//$node_item =  theme('minuto_item',array('item' => $item));

				$forjson =  array('resultado' => $node->field_resultado[0]['value'],'message' => $item['comment'],'tiempo' => $item['minute'],'id' => $item['id'],'imagen' => $item['icon']);


				$forjson = drupal_to_js($forjson);
				echo $forjson;
				exit();
			}
		}
	}

	function minuto_a_minuto_borrar($item_id){
		if(!is_numeric($item_id)){
			echo "false";
		}

		$game_id = db_query('SELECT nid FROM minuto_minuto  WHERE id = %d',$item_id);
		$game_id = db_fetch_object($game_id);

		db_query('DELETE FROM minuto_minuto WHERE id = %d',$item_id);

		update_cache($game_id->nid);


		echo "success";
	}

	function minuto_a_minuto_delete($partido_id){
		
		if(!is_numeric($partido_id)){
			return false;
		}

		//Borramos el nodo
		node_delete($partido_id);

		//Borramos todas las referencias de la narración
		db_query('DELETE FROM minuto_minuto WHERE nid = %d',$partido_id);

		drupal_set_message('Se ha borrado el partido con exito');
		drupal_goto('/admin/content/minuto_minuto');
	}

	function minuto_a_minuto_save_status($tiempo){
	
		$datetime = strtotime("now");

		$node = node_load($_POST['nid']);

		$node->field_status[0]['value'] =  $_POST['status'];
		if($_POST['status'] == 1){
			$node->field_primer_tiempo[0]['value'] = date('Y-m-d H:i:s',$datetime);
		}elseif($_POST['status'] == 2){
			$node->field_segundo_tiempo[0]['value'] = date('Y-m-d H:i:s',$datetime);
		}

		node_save($node);
	}


	function update_cache($game_id){
		$node = node_load($game_id,NULL,TRUE);
			
		$marcador = $node->field_resultado[0]['value'];
		$local    = $node->field_local[0]['value'];
		$visita   = $node->field_visitante[0]['value'];
		$tiempo = $node->field_status[0]['value'];

		$timeline = get_timeline($game_id);
		$output = theme(
    			'minuto_public',
				 array(
					'timeline' => $timeline,
					'marcador' => $marcador,
					'local'    => $local,
					'visita'   => $visita,
					'tiempo'   => date('Y-m-d-H-i-s',strtotime($time)),
					'status'   => (int)$tiempo
				)
		);

		if(metodo== 'bd'){

			$s = db_query("SELECT count(id) as total FROM minuto_cache  WHERE game_id = %d",$game_id);
			$s = db_fetch_object($s);
			if($s->total > 0){
      	dd('UPDATE minuto_cache SET content = "'.$output.'" WHERE game_id = '.$game_id.'');
				db_query('UPDATE minuto_cache SET content = "%s" WHERE game_id = %d',$output,$game_id);
			}else{
				db_query('INSERT INTO minuto_cache VALUES ("","%s",%d)',$output,$game_id);
			}
			
		}

		return true;
	}
?>
